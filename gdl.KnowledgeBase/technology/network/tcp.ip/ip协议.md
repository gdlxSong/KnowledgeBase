### IP协议

##### IPv4

![1571537308884](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1571537308884.png)

###### 版本号

​	版本号占4bit， ipv4的版本号就是4(0100), 通信双方的版本号必须一致。

###### 首部长度

​	首部长度占4bit, 首部长度的单位是4bytes, 首部长度最小为0101(5*4 = 20 bytes)， 最大长度为60bytes，不足填充为4bytes的倍数。

###### 区分服务

​	区分服务占8bit，用于区分上层服务类型，一直未被使用过。

###### 总长度

​	总长度占16bit，用于保存ip报文(ip头+数据)的总长度，最大65535bytes， 如果上层数据超过负载就分组传输。

###### 标识

​	表示占16位，用于由于tcp传下来的数据包可能超过ip的负载，会进行分组传输，而标识就可以在ip层进行表示同一tcp数据包的数据，方便接收端重组。

###### 标识

​	标识占3bit，|MF|DF|Reserve|， MF(more fragment), MF=1表示后面还有分片，MF=0表示已经是最后一个分片。DF(don't fragment)， DF=1表示不允许分片，反之。会分片的原因在于不同网络的MTU大小不一样。

###### 片偏移

​	标识分片中的数据序列，占13bit，基本单位是8bytes.

###### 生存时间

​	占8bit，生存时间就是数据包在路由器之前传递的跳数。TTL(Time To Live)。

###### 协议

​	协议字段占8bit，知名携带数据是何种协议。

| 协议类型   | ICMP | IGMP | IP   | TCP  | EGP  | IGP  | UDP  | IPv6 | ESP  | OSPF |
| ---------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 协议字段值 | 1    | 2    | 4    | 6    | 8    | 9    | 17   | 41   | 50   | 89   |

###### 首部校验和

​	首部校验和占16位，此校验只是校验首部字段。



##### 关于分组合分片

​	分组：分组发生在tcp数据包封装成ip数据报的过程中，如果tcp数据包+ip头超过65535bytes就会发生分组，就是将tcp数据包封装成多个ip数据包，这是不同的ip数据包用''标识''字段标识。

​	分片：分片操作发生在ip数据包传递给数据链路层的过程中，因为链路层的MTU是有限的，以太网为1500，所以ip数据包会进行分片封装成多个链路帧，不同链路帧使用片偏移标识。最后到接受端可以按照偏移重组成一个ip数据包。

​	分组和分片操作都是由ip层来完成，ip-tcp传输的是完整的tcp报文，ip-mac传输的是一个链路帧的数据部分。





###### MTU

​	最大传输单元，这个的大小和链路层协议的类型有关。以太网是1500bytes。

​	note：在tcp/ip中有巡回地址(127.0.0.1)这些巡回地址的数据不会通过网卡进入链路层传输，所以其MTU为65535bytes。

![1571538353240](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1571538353240.png)





------------



### IPv6

![1571541381038](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1571541381038.png)





###### 版本

​	版本号占4bit， IPv6的版本号为6。

###### 通信量类(traffic class)

​	占8bit， 区分不同的IPv6数据报的类别和优先级。

###### 流标号(flow label)

​	占20bit，IPv6的一个新机制，支持资源的预分配。并允许路由器把每一个数据报与一个给定的资源分配相关联。IPv6提出流(flow)这一抽象概念。所谓流，就是互联网上从特定的源点到特定终点(单播或多播)的一系列的数据报，而这个‘流’所经过的路由器保证其指明的服务质量。所有属于同一个流的数据报具有同一个流标号(来自不同的服务器的流的标号会冲突吗？)，因此流在传输音频/视频流的时候特别有效，在传输非实时数据(邮件等)的时候无效，置为0即可。

###### 有效负荷长度

​	占16bit，它指明IPv6数据报除首部以外的字节数，最大为64K。

###### 下一个首部

​	占8bit，当IPv6数据报没有扩展首部的时候，下一个首部就和IPv4中的协议字段一个作用，当IPv6数据报存在扩展首部的时候，下一个首部字段标识后面第一个扩展首部的类型。

###### 跳数限制

​	占8位，功能同TTL。



##### IPv6的目的地址分类

​	单播(unicast)：单播就是传统的点到点通信。

​	多播(multicast)：多播就是一对多的通信。

​	任播(anycast)：任播的目的主机是一组主机，但交付的只是其中任意一个，通常是最近的。



##### 冒号十六进制记法

​	IPv6的地址是128bit，使用点分十进制不合适，所以采用冒号十六进制记法，她把每16位用16进制表示，各值之间使用冒号分割。在冒号十六进制记法中，允许把数字前面的0省略，把0000记为0，冒号十六进制记法允许0压缩，也就是所有0000几位一对::，一个地址中只允许一次零压缩。

​	

##### 从IPv4到IPv6过度

​	由于IPv4的普遍性和设备之间，软件应用之间的耦合，导致IPv6的更替是缓慢的，有两种策略：双协议栈，隧道技术。

​	但是无论是双协议栈还是隧道技术在寻址上都会变成交叉寻址。



###### 最后总结一下：IP层不可靠，IP层的主要功能就是在internet建立数据传输通道(IP)，IP的核心功能有分组和分片。













